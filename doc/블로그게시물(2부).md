## ğŸ¤” ë“¤ì–´ê°€ë©°

[**1ë¶€**ì—ì„œëŠ” í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì˜ ê¸°ë³¸ êµ¬ì¡°ë¥¼ ë§Œë“¤ì—ˆë‹¤.](https://velog.io/@dannysir/JavaScript-í…ŒìŠ¤íŠ¸-ë¼ì´ë¸ŒëŸ¬ë¦¬-ë§Œë“¤ê¸°-1ë¶€)

**2ë¶€**ì—ì„œëŠ” ê°€ì¥ ê³ ë¯¼ì´ ë§ì•˜ë˜Â **ëª¨í‚¹(Mocking) ì‹œìŠ¤í…œ**Â êµ¬í˜„ì— ëŒ€í•´ ë‹¤ë£° ì˜ˆì •ì´ë‹¤.

ëª¨í‚¹ì€ ì™¸ë¶€ ì˜ì¡´ì„±ì„ ê°€ì§œ êµ¬í˜„ìœ¼ë¡œ ëŒ€ì²´í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ë…ë¦½ì ìœ¼ë¡œ ë§Œë“œëŠ” í•µì‹¬ ê¸°ëŠ¥ì´ë‹¤. JavaScriptì˜ ESM(ES6 Modules)ì€ ì •ì ìœ¼ë¡œ ë¶„ì„ë˜ê³  ìºì‹±ë˜ê¸° ë•Œë¬¸ì— ëŸ°íƒ€ì„ì— ëª¨ë“ˆì„ ë³€ê²½í•˜ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

ë”°ë¼ì„œ Babelì„ ì´ìš©í•´ mockì´ ë“±ë¡ëœ ëª¨ë“ˆì€ ì›ë³¸ ëŒ€ì‹  mock ê°ì²´ë¥¼ ê°€ì ¸ì˜¤ë„ë¡ import êµ¬ë¬¸ì„ ë³€í™˜í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í–ˆë‹¤.

## ğŸ’¡ ëª¨í‚¹? & êµ¬í˜„ ì„¤ê³„

### ğŸ“‹ ëª¨í‚¹(Mocking)?
Jestë¥¼ ì‚¬ìš©í•˜ë©° ì •ë§ ë§ì´ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ” ê¸°ëŠ¥ì´ ëª¨í‚¹ ê¸°ëŠ¥ì´ì—ˆë‹¤.

**ê·¸ëŸ¼ ëª¨í‚¹ì€ ì–´ë–¤ ê²½ìš°ì— ì‚¬ìš©í•˜ê²Œ ë ê¹Œ?**

ì˜ˆë¥¼ ë“¤ì–´ ì•„ë˜ì™€ ê°™ì€Â **ëœë¤í•œ ê°’ì„ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜**ë¥¼ í…ŒìŠ¤íŠ¸í•œë‹¤ê³  í•´ë³´ì.

- í…ŒìŠ¤íŠ¸ëŠ” ê²°ê³¼ë¥¼ ì˜ˆì¸¡í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤
- `Math.random()`ì€ ë§¤ë²ˆ ë‹¤ë¥¸ ê°’ì„ ë°˜í™˜í•˜ë¯€ë¡œ ì˜ˆì¸¡ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤

```jsx
// random.js
export const random = () => Math.random();

// game.js
import { random } from './random.js';

export const play = () => random() * 10;

// main.test.js
test('play returns value', () => {
  const result = play();
  expect(result).toBe(???); // ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥!
});
```

ë°”ë¡œ ì´ëŸ° ê²½ìš° ëª¨í‚¹ì´ í•„ìš”í•˜ë‹¤.

`random`ì„ ëª¨í‚¹í•˜ì—¬ ìš°ë¦¬ê°€ ì˜ˆì¸¡ í•  ìˆ˜ ìˆëŠ” ê°’ì„ ë¦¬í„´í•˜ê²Œ ë§Œë“¤ì–´
í…ŒìŠ¤íŠ¸ê°€ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

### ğŸ“‹ ì–´ë–»ê²Œ êµ¬í˜„í• ê¹Œ?

1. Wrapper ê°™ì€ê±¸ êµ¬í˜„?
    - Wrapperë¥¼ êµ¬í˜„í•´ë„ ì‚¬ìš©ìê°€ ì •ì  importë¥¼ í•˜ë©´ ì»´íŒŒì¼ ìˆœê°„ì— ë°”ë¡œ ê°€ì ¸ì˜¤ê¸° ë•Œë¬¸ì— ìˆ˜ì •ì´ ë¶ˆê°€ëŠ¥
2. importë¥¼ ì§ì ‘ ì œì–´?
    - Node.js Loader Hooksë¼ëŠ” ì‹¤í—˜ì ì¸ ê¸°ëŠ¥ì´ ìˆëŠ”ê²ƒì„ ë°œê²¬í–ˆì§€ë§Œ êµ¬í˜„ì˜ ë‚œì´ë„ê°€ ë†’ìŒ


```jsx
import { random } from './random.js';

```

**ê·¸ëŸ¼ JestëŠ”?**

JestëŠ” ESMê³¼ CommonJS ë°©ì‹ì„ ëª¨ë‘ ì§€ì›í•˜ì§€ë§Œ, ë‚´ë¶€ì ìœ¼ë¡œëŠ” CommonJS ë°©ì‹ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤.

**ê·¸ëŸ¼ ë­ê°€ ë‹¤ë¥¸ ê±¸ê¹Œ?**

`require()`ëŠ” ëŸ°íƒ€ì„ì— ì‹¤í–‰ë˜ë©°, JestëŠ” ì´ ì‹œì ì— ëª¨ë“ˆì„ ê°€ë¡œì±„ì„œ mockìœ¼ë¡œ êµì²´í•œë‹¤.

ë°˜ë©´ ì •ì Â `import`ëŠ” ì½”ë“œ ì‹¤í–‰ ì „ì— ëª¨ë“ˆì´ ë¯¸ë¦¬ ë¡œë“œë˜ê¸° ë•Œë¬¸ì— ëŸ°íƒ€ì„ì— ê°€ë¡œì±„ëŠ” ê²ƒì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

### ğŸ“‹ í•´ê²° ì „ëµ: Babelë¡œ ì½”ë“œ ë³€í™˜í•˜ê¸°

í•µì‹¬ ì•„ì´ë””ì–´ëŠ” ê°„ë‹¨í•˜ë‹¤.

1. Babelì„ í†µí•´ ëª¨ë“  íŒŒì¼ì˜ import êµ¬ë¬¸ì„ ë³€í™˜í•œë‹¤
2. í•´ë‹¹ ê²½ë¡œê°€ mockì— ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ mock ê°ì²´ë¥¼ ê°€ì ¸ì˜¨ë‹¤
3. mockì— ë“±ë¡ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì›ë³¸ ëª¨ë“ˆì„ ê°€ì ¸ì˜¨ë‹¤

```jsx
// ë³€í™˜ ì „
import { random } from './random.js';

// ë³€í™˜ í›„
const _module = mockStore.has('/absolute/path/random.js')
  ? mockStore.get('/absolute/path/random.js')
  : await import('./random.js');
const { random } = _module;

```

### ğŸ“‹ Mock Store ì„¤ê³„

ì•ì„  í•´ê²° ì „ëµì— ë”°ë¼ mockì„ êµ¬í˜„í•˜ë ¤ë©´ ìš°ì„  mockë“¤ì„ ì €ì¥í•  **Store**ê°€ í•„ìš”í•˜ë‹¤.

**êµ¬í˜„ ë¡œì§**

- `mockStore`: **Map** ìë£Œêµ¬ì¡°ë¡œ ëª¨ë“ˆ ê²½ë¡œë¥¼ key, mock ê°ì²´ë¥¼ valueë¡œ ì €ì¥
- **ê·¸ ì™¸ í•¨ìˆ˜ë“¤**: Map ê°ì²´ë¥¼ í™œìš©í•´ CRUD ê¸°ëŠ¥ êµ¬í˜„

```jsx
// store.js
export const mockStore = new Map();

export function mock(modulePath, mockExports) {
  mockStore.set(modulePath, mockExports);
}

export function clearAllMocks() {
  mockStore.clear();
}

export function unmock(modulePath) {
  mockStore.delete(modulePath);
}

export function isMocked(modulePath) {
  return mockStore.has(modulePath);
}

```

## ğŸ’¡ Babel í”ŒëŸ¬ê·¸ì¸ êµ¬í˜„í•˜ê¸°

ì´ì œ Babelì„ ì´ìš©í•´ì„œ importë¬¸ì„ ì°¾ì•„ ë³€í™˜í•´ì•¼ í•œë‹¤.

**ê¸°ë³¸ êµ¬ì¡°**

- `babelTransformImport`
    - ì§ì ‘ êµ¬í˜„í•  í”ŒëŸ¬ê·¸ì¸
    - importë¬¸ì„ ì¡°ê±´ë¶€ ë™ì  importë¡œ ë³€í™˜
- `dynamicImport`
    - ë³€í™˜ ê²°ê³¼ì— í¬í•¨ë  `await import()` êµ¬ë¬¸ì„ Babelì´ ì²˜ë¦¬í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” í”ŒëŸ¬ê·¸ì¸

**ì „ì²´ êµ¬ì¡°**

```jsx
// cli.js
const transformFile = (filePath) => {
  const originalCode = fs.readFileSync(filePath, 'utf-8');
  originalFiles.set(filePath, originalCode);

  const transformed = transformSync(originalCode, {
    filename: filePath,
    plugins: [babelTransformImport],
    parserOpts: {
      sourceType: 'module',
      plugins: ['dynamicImport']
    }
  });

  fs.writeFileSync(filePath, transformed.code);
};

// babelTransformImport.js
export const babelTransformImport = ({ types: t }) => {
  return {
    visitor: {
      Program(path) {
        // 1. mockStore import ìë™ ì¶”ê°€
      },
      ImportDeclaration(nodePath, state) {
        // 2. import êµ¬ë¬¸ì„ ì¡°ê±´ë¶€ ë™ì  importë¡œ ë³€í™˜
      }
    }
  };
};

```

### ğŸ“‹ `Program`? `ImportDeclaration`?

`babelTransformImport` í•¨ìˆ˜ì˜ êµ¬ì¡°ë¥¼ ì²˜ìŒ ë³´ë©´ ëª¨ë“  ê²Œ ì˜ì•„í•  ê²ƒì´ë‹¤.

ì´ í•¨ìˆ˜ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **visitor íŒ¨í„´**ì„ ë”°ë¥´ê³  ìˆìœ¼ë©°, Babel ê°ì²´ë¥¼ ì¸ìë¡œ ë°›ëŠ”ë‹¤.

**ê·¸ëŸ¼ visitorëŠ” ë¬´ì—‡ì¼ê¹Œ?**

visitorëŠ” AST(Abstract Syntax Tree)ì˜ ê° ë…¸ë“œë¥¼ ìˆœíšŒí•˜ë©°, íŠ¹ì • íƒ€ì…ì˜ ë…¸ë“œë¥¼ ë§Œë‚¬ì„ ë•Œ ì–´ë–»ê²Œ ì²˜ë¦¬í• ì§€ ì •ì˜í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.

- `Program`: íŒŒì¼ ì „ì²´ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë£¨íŠ¸ ë…¸ë“œ, ìµœì´ˆ 1íšŒ ì‹¤í–‰
- `ImportDeclaration`: `import` ë¬¸ì„ ë§Œë‚˜ë©´ ì‹¤í–‰
- `VariableDeclaration`: `let`, `const`, `var`ë¥¼ ë§Œë‚˜ë©´ ì‹¤í–‰
- `IfStatement`: `if`ë¬¸ì„ ë§Œë‚˜ë©´ ì‹¤í–‰
- `ForStatement`: `for`ë¬¸ì„ ë§Œë‚˜ë©´ ì‹¤í–‰

ì´ì œ ì´ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•˜ë‚˜ì”© êµ¬í˜„í•´ë³´ì.

### ğŸ“‹ 1ë‹¨ê³„: mockStore ìë™ import

ëª¨ë“  íŒŒì¼ ìµœìƒë‹¨ì— `mockStore`ë¥¼ ìë™ìœ¼ë¡œ importí•œë‹¤.

```jsx
Program(path) {
  const importStatement = t.ImportDeclaration(
    [t.importSpecifier(
      t.identifier('mockStore'),
      t.identifier('mockStore')
    )],
    t.stringLiteral('@dannysir/js-te/src/mock/store.js')
  );
  path.node.body.unshift(importStatement);
}

```

**ê²°ê³¼**

```jsx
// ìë™ ì¶”ê°€ë¨
import { mockStore } from '@dannysir/js-te/src/mock/store.js';

```

### ğŸ“‹ 2ë‹¨ê³„: Import êµ¬ë¬¸ ë³€í™˜ ì „ì²´ ì„¤ê³„

ìš°ì„  í•˜ë‚˜ì”© ì„¤ê³„í•´ë³´ì.

`ImportDeclaration`ì˜ êµ¬ì¡°ë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ë‹¤.

**ì£¼ìš” ë³€ìˆ˜**

- `source`: ê¸°ì¡´ importë¬¸ì˜ ê²½ë¡œ
- `specifiers`: import í•­ëª©ë“¤ì´ ë‹´ê¸´ ë°°ì—´

```jsx
// ê¸°ì¡´ importë¬¸
import { play } from './game.js';
import { play as gamePlay } from './game.js';

// AST ë‚´ë¶€ specifiers êµ¬ì¡°
specifiers: [
  {
    type: 'ImportSpecifier',
    imported: { name: 'play' },
    local: { name: 'play' }
  },
  {
    type: 'ImportSpecifier',
    imported: { name: 'play' },
    local: { name: 'gamePlay' }
  }
]

```

**ë³€í™˜ì— í•„ìš”í•œ ë³€ìˆ˜ë“¤**

- `moduleDeclaration`: **ìƒˆë¡­ê²Œ ë§Œë“  importë¬¸** (3í•­ ì—°ì‚°ì + ë™ì  importë¬¸)
- `extractDeclarations`: ì„ ì–¸ëœ ëª¨ë“ˆë“¤ì„ êµ¬ì¡° ë¶„í•´ í• ë‹¹í•˜ê¸° ìœ„í•œ ë°°ì—´
- `extractDeclaration`: ê°ê°ì˜ ëª¨ë“ˆì„ êµ¬ì¡° ë¶„í•´ í• ë‹¹í•˜ì—¬ ì„ ì–¸

**ì „ì²´ ë¡œì§ êµ¬ì¡°**

```jsx
ImportDeclaration(nodePath, state) {
  const source = nodePath.node.source.value;

  // mockStore importëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
  if (source === '@dannysir/js-te/src/mock/store.js') {
    return;
  }

  // 1. ì¡°ê±´ë¶€ import ìƒì„±
  const specifiers = nodePath.node.specifiers;
  const moduleVarName = nodePath.scope.generateUidIdentifier('module');

  const moduleDeclaration = t.variableDeclaration('const', [
    // 3ë‹¨ê³„ì—ì„œ êµ¬í˜„
  ]);

  // 2. ê°œë³„ ë³€ìˆ˜ ì¶”ì¶œ
  const extractDeclarations = specifiers.map(spec => {
    // 4ë‹¨ê³„ì—ì„œ êµ¬í˜„
  });

  const extractDeclaration = t.variableDeclaration('const', extractDeclarations);

  // 3. ì›ë³¸ importë¥¼ ë³€í™˜ëœ ì½”ë“œë¡œ êµì²´
  nodePath.replaceWithMultiple([moduleDeclaration, extractDeclaration]);
}

```

### **ğŸ“‹ 3ë‹¨ê³„: ì¡°ê±´ë¶€ ë™ì  import ìƒì„±**

ì´ì œ í•˜ë‚˜ì”© êµ¬í˜„í•´ë³´ì.

> ì „ì²´ ì½”ë“œë¥¼ í•œ ë²ˆì— ë³´ë©´ ë³µì¡í•´ ë³´ì´ë‹ˆ ë‹¨ê³„ë³„ë¡œ ì‚´í´ë³´ì.
>

**êµ¬í˜„ ë‹¨ê³„**

1. `module`ì´ë¼ëŠ” ì´ë¦„ì˜ ê³ ìœ  ë³€ìˆ˜ ìƒì„±
2. 3í•­ ì—°ì‚°ì ìƒì„±
    - ì¡°ê±´: `mockStore.has(ê²½ë¡œ)`
    - ì°¸ì¼ ë•Œ: `mockStore.get(ê²½ë¡œ)`
    - ê±°ì§“ì¼ ë•Œ: `await import(ê²½ë¡œ)`

```jsx
const moduleDeclaration = t.variableDeclaration('const', [
  t.variableDeclarator(
    moduleVarName,
    // 3í•­ ì—°ì‚°ì ìƒì„±
    t.conditionalExpression(
      // ì¡°ê±´: mockStoreì— í•´ë‹¹ ê²½ë¡œê°€ ìˆëŠ”ì§€ í™•ì¸
      t.callExpression(
        t.memberExpression(t.identifier('mockStore'), t.identifier('has')),
        [t.stringLiteral(source)]
      ),
      // ì°¸ì¼ ë•Œ: mockStoreì—ì„œ mock ê°ì²´ ê°€ì ¸ì˜¤ê¸°
      t.callExpression(
        t.memberExpression(t.identifier('mockStore'), t.identifier('get')),
        [t.stringLiteral(source)]
      ),
      // ê±°ì§“ì¼ ë•Œ: ì›ë³¸ ëª¨ë“ˆ ë™ì  import
      t.awaitExpression(
        t.importExpression(t.stringLiteral(source))
      )
    )
  )
]);

```

**ì¶œë ¥ ì˜ˆì‹œ**

```jsx
const _module = mockStore.has('./random.js')
  ? mockStore.get('./random.js')
  : await import('./random.js');

```

### ğŸ“‹ 4ë‹¨ê³„: êµ¬ì¡° ë¶„í•´ í• ë‹¹ ì²˜ë¦¬

ì´ì œ importí•œ ëª¨ë“ˆì—ì„œ í•„ìš”í•œ í•­ëª©ë“¤ì„ ì¶”ì¶œí•´ì•¼ í•œë‹¤.

Import ë°©ì‹ì—ëŠ” ì„¸ ê°€ì§€ íƒ€ì…ì´ ìˆë‹¤:

1. **Named Import**: `import { random } from './random.js'`
2. **Default Import**: `import random from './random.js'`
3. **Namespace Import**: `import * as random from './random.js'`

ê° íƒ€ì…ì— ë§ê²Œ ì²˜ë¦¬í•œë‹¤.

```jsx
// ê°œë³„ ë³€ìˆ˜ ì¶”ì¶œ
const extractDeclarations = specifiers.map(spec => {
  let importedName, localName;

  // 1. Default Import ì²˜ë¦¬
  if (t.isImportDefaultSpecifier(spec)) {
    importedName = 'default';
    localName = spec.local.name;
  }
  // 2. Namespace Import ì²˜ë¦¬ (import * as name)
  else if (t.isImportNamespaceSpecifier(spec)) {
    localName = spec.local.name;
    return t.variableDeclarator(
      t.identifier(localName),
      moduleVarName  // ì „ì²´ ëª¨ë“ˆì„ ê·¸ëŒ€ë¡œ í• ë‹¹
    );
  }
  // 3. Named Import ì²˜ë¦¬
  else {
    importedName = spec.imported.name;
    localName = spec.local.name;
  }

  return t.variableDeclarator(
    t.identifier(localName),
    t.memberExpression(moduleVarName, t.identifier(importedName))
  );
});

const extractDeclaration = t.variableDeclaration('const', extractDeclarations);

```

**ì¶œë ¥ ì˜ˆì‹œ**

```jsx
// Named Import
const { random } = _module;

// Default Import
const { default: random } = _module;

// Namespace Import
const random = _module;
```

### ğŸ“‹ 5ë‹¨ê³„: ë³€í™˜í•œ importë¬¸ìœ¼ë¡œ êµì²´

ë§ˆì§€ë§‰ìœ¼ë¡œ ì›ë³¸ importë¬¸ì„ ìƒˆë¡œ ìƒì„±í•œ ì½”ë“œë¡œ êµì²´í•œë‹¤.

```jsx
// ì›ë³¸ importë¥¼ ë³€í™˜ëœ ì½”ë“œë¡œ êµì²´
nodePath.replaceWithMultiple([moduleDeclaration, extractDeclaration]);
```

`replaceWithMultiple`ì€ í•˜ë‚˜ì˜ ë…¸ë“œë¥¼ ì—¬ëŸ¬ ê°œì˜ ë…¸ë“œë¡œ êµì²´í•  ë•Œ ì‚¬ìš©í•œë‹¤.

### ğŸ“‹ ë³€í™˜ ê²°ê³¼ ì˜ˆì‹œ

**ë³€í™˜ ì „**

```jsx
import { random } from './random.js';
```

**ë³€í™˜ í›„**

```jsx
import { mockStore } from '@dannysir/js-te/src/mock/store.js';

const _module = mockStore.has('./random.js')
  ? mockStore.get('./random.js')
  : await import('./random.js');
const { random } = _module;
```

ì´ì œ importë¬¸ì´ ì‹¤í–‰ë  ë•Œë§ˆë‹¤

1. mockStoreì— í•´ë‹¹ ê²½ë¡œê°€ ë“±ë¡ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
2. ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ mock ê°ì²´ ì‚¬ìš©
3. ì—†ìœ¼ë©´ ì›ë³¸ ëª¨ë“ˆ import

ì´ë ‡ê²Œ ë™ì‘í•˜ê²Œ ëœë‹¤

## ğŸ’¡ ë¬¸ì œì  ë°œê²¬

ì´ì œ ì‚¬ìš©ìëŠ” ë‹¤ìŒê³¼ ê°™ì´ ëª¨í‚¹ì„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```jsx
// random.js
export const random = () => {
  return Math.floor(Math.random() * 10);
}

// game.js
import { random } from './random.js'

export const play = () => {
  return random() * 10;
}

// game.test.js
test('[mocking] - mocking random function', async () => {
  mock('./random.js', {
    random: () => 3,
  });
  const { play } = await import('./game.js');
  expect(play()).toBe(30);
});

```

**ë™ì‘ ê³¼ì •**

1. `mock('./random.js', { random: () => 3 })`ë¡œ mock ë“±ë¡
2. `game.js`ë¥¼ importí•˜ë©´ Babelì´ ì½”ë“œë¥¼ ë³€í™˜
3. `game.js` ë‚´ë¶€ì˜ `import { random }`ì´ ì‹¤í–‰ë  ë•Œ mockStore í™•ì¸
4. `'./random.js'`ê°€ ë“±ë¡ë˜ì–´ ìˆìœ¼ë¯€ë¡œ `random: () => 3` ì‚¬ìš©
5. `play()`ëŠ” `3 * 10 = 30` ë°˜í™˜

### ğŸ“‹ ìƒëŒ€ ê²½ë¡œì˜ í•¨ì •

ê·¸ëŸ°ë° ì—¬ê¸°ì„œ í•œ ê°€ì§€ ë¬¸ì œê°€ ìƒê¸´ë‹¤.

ì‚¬ìš©ìê°€ ìƒëŒ€ ê²½ë¡œë¥¼ ì´ìš©í•  ê²½ìš°

- ëª¨ë“ˆì´ ì‚¬ìš©ë˜ëŠ” **ìœ„ì¹˜ì— ë”°ë¼ import ê²½ë¡œê°€ ë‹¬ë¼ì§**
- Map ê°ì²´ì— ì €ì¥ëœ ê²½ë¡œëŠ” **1ê°œ**
- ê²½ë¡œê°€ ë‹¬ë¼ì§€ë©´ Mapì—ì„œ ì°¾ì§€ ëª»í•˜ëŠ” ë¬¸ì œ ë°œìƒ

**ì˜ˆì‹œë¡œ ì‚´í´ë³´ì**

```
project/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â””â”€â”€ random.js
â”‚   â””â”€â”€ game.js
â””â”€â”€ test/
    â””â”€â”€ game.test.js

```

```jsx
// game.test.jsì—ì„œ mock ë“±ë¡
mock('./random.js', { random: () => 3 });
// Mapì— './random.js'ë¡œ ì €ì¥ë¨

// game.jsì—ì„œ import
import { random } from '../utils/random.js';
// Babelì´ '../utils/random.js'ë¡œ ë³€í™˜
// Mapì—ì„œ './random.js'ë¥¼ ì°¾ì§€ ëª»í•¨!

```

**ê²°ê³¼**: Mockì´ ì ìš©ë˜ì§€ ì•Šê³  ì›ë³¸ ëª¨ë“ˆì´ importëœë‹¤.

### ğŸ“‹ ì ˆëŒ€ ê²½ë¡œ ë³€í™˜ìœ¼ë¡œ í•´ê²°í•˜ê¸°

ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **ëª¨ë“  ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ í†µì¼**í•˜ê¸°ë¡œ í–ˆë‹¤.

**í•´ê²° ì „ëµ**

1. ì‚¬ìš©ìì˜ importë¬¸ í™•ì¸
2. í˜„ì¬ íŒŒì¼ì˜ ë””ë ‰í† ë¦¬ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì ˆëŒ€ ê²½ë¡œ ê³„ì‚°
3. ì ˆëŒ€ ê²½ë¡œë¥¼ í†µí•´ Mapì—ì„œ ì°¾ê¸°

Babel í”ŒëŸ¬ê·¸ì¸ì— ë‹¤ìŒ ë¡œì§ì„ ì¶”ê°€í•œë‹¤.

```jsx
ImportDeclaration(nodePath, state) {
  const source = nodePath.node.source.value;

  if (source === '@dannysir/js-te/src/mock/store.js') {
    return;
  }

  // ğŸ”¥ ì ˆëŒ€ ê²½ë¡œ ë³€í™˜ ì¶”ê°€
  const currentFilePath = state.filename || process.cwd();
  const currentDir = path.dirname(currentFilePath);

  let absolutePath;
  if (source.startsWith('.')) {
    // ìƒëŒ€ ê²½ë¡œ â†’ ì ˆëŒ€ ê²½ë¡œ ë³€í™˜
    absolutePath = path.resolve(currentDir, source);
  } else {
    // npm íŒ¨í‚¤ì§€ëŠ” ê·¸ëŒ€ë¡œ
    absolutePath = source;
  }

  // ì´ì œ absolutePathë¥¼ ì‚¬ìš©í•˜ì—¬ mockStore ì²´í¬
  const moduleDeclaration = t.variableDeclaration('const', [
    t.variableDeclarator(
      moduleVarName,
      t.conditionalExpression(
        t.callExpression(
          t.memberExpression(t.identifier('mockStore'), t.identifier('has')),
          [t.stringLiteral(absolutePath)]  // ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
        ),
        t.callExpression(
          t.memberExpression(t.identifier('mockStore'), t.identifier('get')),
          [t.stringLiteral(absolutePath)]  // ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
        ),
        t.awaitExpression(
          t.importExpression(t.stringLiteral(source))  // ì›ë³¸ ê²½ë¡œë¡œ import
        )
      )
    )
  ]);

  // ... ë‚˜ë¨¸ì§€ ì½”ë“œ
}

```

**ë³€í™˜ ê²°ê³¼**

```jsx
// game.jsì—ì„œ ì´ë ‡ê²Œ ì‘ì„±í•´ë„
import { random } from '../utils/random.js';

// Babelì´ ì´ë ‡ê²Œ ë³€í™˜
const _module = mockStore.has('/Users/san/project/src/utils/random.js')
  ? mockStore.get('/Users/san/project/src/utils/random.js')
  : await import('../utils/random.js');

```

ì´ì œ mock ë“±ë¡ê³¼ Babel ë³€í™˜ ëª¨ë‘ **ë™ì¼í•œ ì ˆëŒ€ ê²½ë¡œ**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•íˆ ë§¤ì¹­ëœë‹¤!

## ğŸ’¡ CLIì—ì„œ ë³€í™˜ í†µí•©í•˜ê¸°

ì´ì œ í”ŒëŸ¬ê·¸ì¸ ê°œë°œì„ ì™„ë£Œí–ˆë‹¤.

ê·¸ëŸ¼ CLI ë¶€ë¶„ ë¡œì§ì„ ìˆ˜ì •í•´ì•¼ í•œë‹¤.

### ğŸ“‹ íŒŒì¼ ë³€í™˜ ë° ë³µêµ¬

**ì „ì²´ íë¦„**

1. ì „ì²´ íŒŒì¼ íƒìƒ‰
2. importë¬¸ ë³€í™˜
3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
4. ì›ë³¸ ì½”ë“œ ë³µêµ¬ (ë§¤ìš° ì¤‘ìš”!)

```jsx
const originalFiles = new Map();

// 1. íŒŒì¼ ë³€í™˜ í•¨ìˆ˜
const transformFile = (filePath) => {
  const originalCode = fs.readFileSync(filePath, 'utf-8');
  originalFiles.set(filePath, originalCode);  // ì›ë³¸ ì €ì¥

  const transformed = transformSync(originalCode, {
    filename: filePath,
    plugins: [babelTransformImport],
    parserOpts: {
      sourceType: 'module',
      plugins: ['dynamicImport']
    }
  });

  fs.writeFileSync(filePath, transformed.code);
};

// 2. ì›ë³¸ ë³µêµ¬ í•¨ìˆ˜
const restoreFiles = () => {
  for (const [filePath, originalCode] of originalFiles.entries()) {
    fs.writeFileSync(filePath, originalCode);
  }
};

```

**ì „ì²´ ì½”ë“œ íë¦„**

```jsx
// 1. ëª¨ë“  ì†ŒìŠ¤ íŒŒì¼ ì°¾ê¸° ë° ë³€í™˜
const sourceFiles = findAllSourceFiles(process.cwd());
for (const file of sourceFiles) {
  transformFile(file);
}

// 2. í…ŒìŠ¤íŠ¸ íŒŒì¼ ì°¾ê¸° ë° ë³€í™˜
const testFiles = findTestFiles(process.cwd());

console.log(`\\nFound ${testFiles.length} test file(s)`);

// 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
for (const file of testFiles) {
  console.log(`\\n${file}\\n`);

  transformFile(file);

  await import(path.resolve(file));

  const { passed, failed } = await jsTe.run();
  totalPassed += passed;
  totalFailed += failed;
}

// 4. ì›ë³¸ ë³µêµ¬ (ì¤‘ìš”!)
restoreFiles();

console.log(`\\nTotal: ${totalPassed} passed, ${totalFailed} failed`);

if (totalFailed > 0) {
  process.exit(1);
}

```

**ì™œ ì›ë³¸ ë³µêµ¬ê°€ ì¤‘ìš”í• ê¹Œ?**

- ì‚¬ìš©ìì˜ ì½”ë“œë¥¼ Babelë¡œ ë³€í™˜í•˜ì—¬ ë®ì–´ì”Œì› ê¸° ë•Œë¬¸
- í…ŒìŠ¤íŠ¸ê°€ ëë‚˜ë©´ ë°˜ë“œì‹œ ì›ë³¸ìœ¼ë¡œ ë˜ëŒë ¤ì•¼ í•¨
- ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì‚¬ìš©ìì˜ ì½”ë“œê°€ ë³€í™˜ëœ ìƒíƒœë¡œ ë‚¨ìŒ

### ğŸ“‹ ìµœì¢… ì‚¬ìš© ì˜ˆì‹œ

ì´ì œ í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ **ì ˆëŒ€ ê²½ë¡œ**ë¡œ ë“±ë¡í•˜ë©´, ì‚¬ìš©ìì˜ ì½”ë“œì—ì„œ ì–´ë–»ê²Œ ì‚¬ìš©í•´ë„ ëª¨í‚¹ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•œë‹¤.

```jsx
// random.js
export const random = () => {
  return Math.floor(Math.random() * 10);
}

// game.js
import { random } from './random.js'

export const play = () => {
  return random() * 10;
}

// game.test.js
test('[mocking] - mocking random function', async () => {
  // ì ˆëŒ€ ê²½ë¡œë¡œ mock ë“±ë¡
  mock('/Users/san/Js-Te/test-helper/random.js', {
    random: () => 3,
  });

  const { play } = await import('./game.js');
  expect(play()).toBe(30);
});

```

**ì£¼ì˜ ì‚¬í•­**

1. **mockì€ ë°˜ë“œì‹œ ì ˆëŒ€ ê²½ë¡œë¡œ ë“±ë¡**
    - ìƒëŒ€ ê²½ë¡œ ì‚¬ìš© ì‹œ ë§¤ì¹­ ì‹¤íŒ¨
2. **importëŠ” mock ì´í›„ì— ì‹¤í–‰**
    - mock ì „ì— importí•˜ë©´ ì›ë³¸ ëª¨ë“ˆì´ ë¡œë“œë¨
3. **ë™ì  import(`await import()`) ì‚¬ìš© í•„ìš”**
    - ìµœì¢…ì ìœ¼ë¡œ ì‹¤í–‰í•  ëª¨ë“ˆì˜ ê²½ìš° ë°˜ë“œì‹œ ë™ì  importë¥¼ í•´ì•¼ í•¨
    - ì •ì  importëŠ” íŒŒì¼ ì‹¤í–‰ ì‹œì ì— ì¦‰ì‹œ ë¡œë“œë¨
    - ë™ì  importë¡œ mock ë“±ë¡ í›„ ë¡œë“œí•´ì•¼ í•¨

## ğŸ“ í”„ë¡œì íŠ¸ ë§í¬

- **GitHub**: https://github.com/dannysir/Js-Te
- **npm**:Â https://www.npmjs.com/package/@dannysir/js-te